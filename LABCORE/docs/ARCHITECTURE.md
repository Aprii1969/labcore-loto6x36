# Архитектура системы LABCORE

---

## 1. Хранилища данных и состояние

- **Исторические данные**
  - `data/labcore_draws.csv` — вся история тиражей (№, дата, тип, номера, бонус).
  - `data/pool_stats.json` — частоты, интервалы, зоны активности номеров.
  - `data/glue_stats.json` — статистика совместных выпадений (пары/тройки).
  - `data/structure_stats.json` — статистика структур комбинаций.
  - `config/state.json` — текущее состояние, индексы, счётчики неудач.
  - `config/core_settings.json`, `config/softpool_config.json`, `config/quota_config.json` — основные параметры и пороги.

---

## 2. Генерация и симуляция

- **LABCORE-80 (генератор + симулятор)**
  - Генерирует новые комбинации по актуальным метрикам и структурам.
  - Проводит симуляции (Blind Test) на истории тиражей для проверки качества.
  - Применяет ограничения и фильтры (SoftPool, Glue, Quotas).

---

## 3. Лёгкий адаптер АКК

- Оперативно реагирует на новый тираж:
  - Пересчитывает веса и квоты, применяет Glue-boost.
  - Быстрая попытка скорректировать подход к тиражу в случае неудач.
  - Обновляет связанные конфиги по результату.

---

## 4. Модуль обратного анализа

- Анализирует результаты каждого тиража:
  - Считает метрики: psw, F5–F50, zones, структуры, glue, циклы.
  - Формирует рекомендации и overrides (config_overrides, forced_numbers).
  - Готовит данные для обучения моделей и AIController.

---

## 5. AI-Оркестратор (AIController)

- Централизованный управляющий модуль:
  - Следит за сериями неудач (подряд).
  - Запускает deep-анализ и переключает активные модели.
  - Автоматически применяет overrides и обновления.
  - Триггерится на любое важное событие (`новый тираж`, `порог неудач`).

---

## 6. Пайплайн обучения моделей

- **Группы моделей:**
  - Индивидуальные классификаторы выпадения (XGBoost/LightGBM).
  - Glue-модели для пар/троек (CatBoost).
  - Модели структур и циклов.

- **Автоматизация:**
  - Обновление моделей ежедневно/недельно (cron/Airflow).
  - Версионирование моделей.
  - Feature-engineering и валидация на свежих данных.

---

## 7. Автоматизация и мониторинг

- **Event-driven:**  
  - Любое появление нового результата запускает цепочку обработки через AIController.

- **Stateful:**  
  - `state.json` фиксирует последний обработанный тираж, счётчики и статус АКК.

- **Мониторинг:**  
  - Сбор и визуализация ключевых метрик (hit_5_plus, hit_6, glue_score, cycle_pattern).
  - Алерты и отчёты при аномалиях или длительных падениях.

---

## 8. Внедрение и развитие (по шагам)

1. Доработка KPI_Monitor и ReverseAnalysis — сбор метрик, интеграция с pool_stats, glue_stats и др.
2. Автоматизация feature-engineering и обучения моделей (отдельный сервис/скрипт).
3. Интеграция моделей в генератор (LABCORE_80, АКК) — новые функции для подбора приоритетных номеров, glue-усиления.
4. Расширение AIController: deep-анализ, переключение моделей, blind test.
5. Настройка мониторинга и алертов.

---

## 9. Скрипты и управление

- Основной запуск:  
  `python controllers/ai_controller.py <N>` — обработка последних N тиражей, анализ, обновления.
- Автоматическое сохранение новых моделей и конфигов при улучшениях.

---

## 10. Схема жизненного цикла (текстовая)

```
[draws.csv] 
   ↓
[Обновление pool_stats, glue_stats, structure_stats]
   ↓
[АКК / LABCORE-80: генерация и проверка]
   ↓
[AIController: deep-анализ, переключение моделей, overrides]
   ↓
[Модели: обучение/валидация → генератор/АКК]
   ↓
[Мониторинг → KPI_Monitor → ReverseAnalysis → feedback]
```

---

## 11. Принципы и цели

- Максимальная автоматизация, минимизация ручного вмешательства.
- Жёсткое разделение ответственности между модулями и файлами.
- Прозрачность: логирование, мониторинг, валидация действий.
- Гибкая интеграция новых моделей и правил без переписывания ядра.

---

*Документ — основа проектирования, разработки и поддержки системы LABCORE. Все изменения и новые идеи фиксируются и обсуждаются на его базе.*
